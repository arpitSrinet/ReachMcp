<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Devices</title>
  <style>
    :root {
      --primary-green: #00C853;
      --primary-green-hover: #063418;
      --button-radius: 8px;
      --button-padding: 14px 22px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      padding: 16px;
      background: #f5f5f5;
    }

    .devices-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 24px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .device-card {
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 20px;
      background: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .device-card:hover {
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
      transform: translateY(-2px);
      border-color: var(--primary-green);
    }

    .device-brand {
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .device-name {
      font-size: 20px;
      font-weight: 600;
      color: #333;
      margin-bottom: 16px;
    }

    .device-image-container {
      width: 100%;
      height: 200px;
      background: #f5f5f5;
      border-radius: 8px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    .device-image {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
    }

    .device-image-placeholder {
      width: 120px;
      height: 120px;
      background: #e0e0e0;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      color: #999;
    }

    .device-pricing {
      margin-bottom: 12px;
    }

    .price-row {
      display: flex;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 8px;
    }

    .original-price {
      font-size: 16px;
      color: #999;
      text-decoration: line-through;
    }

    .current-price {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary-green);
    }

    .discount-badge {
      display: inline-block;
      background: var(--primary-green);
      color: white;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      margin-top: 4px;
    }

    .financing-option {
      font-size: 14px;
      color: #666;
      margin-bottom: 16px;
      line-height: 1.5;
    }

    .financing-logo {
      display: inline-block;
      vertical-align: middle;
      margin-left: 4px;
      width: 16px;
      height: 16px;
      background: #1976d2;
      border-radius: 2px;
    }

    .add-to-cart-btn {
      width: 100%;
      background: var(--primary-green);
      color: white;
      border: none;
      border-radius: var(--button-radius);
      padding: var(--button-padding);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .add-to-cart-btn:hover {
      background: var(--primary-green-hover);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .add-to-cart-btn:active {
      transform: translateY(0);
    }
    
    .device-specs {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #e0e0e0;
      font-size: 13px;
      color: #666;
    }

    .specs-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px 16px;
      margin-top: 8px;
    }

    .spec-item {
      display: flex;
      flex-direction: column;
    }

    .spec-label {
      font-weight: 600;
      color: #2e7d32;
      font-size: 12px;
      margin-bottom: 2px;
    }

    .spec-value {
      color: #455a64;
      font-size: 13px;
    }

    .device-meta {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #f0f0f0;
      font-size: 11px;
      color: #999;
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 8px;
    }

    .stock-info {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .stock-available {
      color: #00C853;
    }

    .stock-low {
      color: #ff9800;
    }
    
    .stock-out {
      color: #d32f2f;
    }

    /* Filter Styles */
    .filters-container {
      max-width: 1400px;
      margin: 0 auto 24px;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .filters-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 16px;
    }

    .filters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      align-items: end;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .filter-label {
      font-size: 14px;
      font-weight: 500;
      color: #666;
    }

    .filter-input,
    .filter-select {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s;
    }

    .filter-input:focus,
    .filter-select:focus {
      outline: none;
      border-color: var(--primary-green);
    }

    .filter-checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-checkbox-group:hover {
      border-color: var(--primary-green);
      background: #f5f5f5;
    }

    .filter-checkbox-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--primary-green);
    }

    .filter-checkbox-group label {
      cursor: pointer;
      font-size: 14px;
      color: #333;
      user-select: none;
    }

    .filter-results {
      font-size: 14px;
      color: #666;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e0e0e0;
    }

    .no-results {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }

    .no-results-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
    }

    .no-results-text {
      font-size: 14px;
      margin-bottom: 16px;
    }

    .clear-filters-btn {
      background: #f5f5f5;
      color: #666;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .clear-filters-btn:hover {
      background: #e0e0e0;
      border-color: #ccc;
    }

    @media (max-width: 768px) {
      .filters-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <!-- Filters Container -->
  <div class="filters-container" id="filters-container" style="display: none;">
    <div class="filters-title">üîç Filter Devices</div>
    <div class="filters-grid">
      <div class="filter-group">
        <label class="filter-label">Search</label>
        <input type="text" class="filter-input" id="filter-search" placeholder="Search by name or brand...">
      </div>
      <div class="filter-group">
        <label class="filter-label">Brand</label>
        <select class="filter-select" id="filter-brand">
          <option value="">All Brands</option>
        </select>
      </div>
      <div class="filter-group">
        <label class="filter-label">Max Price ($)</label>
        <input type="number" class="filter-input" id="filter-price" placeholder="No limit" min="0" step="100">
      </div>
      <div class="filter-group">
        <div class="filter-checkbox-group" onclick="toggleEsimFilter()">
          <input type="checkbox" id="filter-esim">
          <label for="filter-esim">eSIM Capable Only</label>
        </div>
      </div>
    </div>
    <div class="filter-results" id="filter-results"></div>
  </div>

  <div class="devices-container" id="devices-container">
    <p style="padding: 20px; text-align: center; color: #666;">Loading devices...</p>
  </div>

  <script>
    // Immediate diagnostic check
    console.log('üîç Devices widget initializing...', {
      hasOpenAI: typeof window.openai !== 'undefined',
      toolOutput: window.openai?.toolOutput,
      toolOutputType: typeof window.openai?.toolOutput,
      allKeys: window.openai ? Object.keys(window.openai) : []
    });

    // Function to render a single device card
    function renderDevice(device) {
      const deviceId = device.id || device.productNumber || device.ean || 'unknown';

      // Get brand from API
      let brand = device.manufacturer?.name || device.brand || device.translated?.manufacturer?.name || '';

      // Get device name
      let name = device.name || device.translated?.name || 'Unknown Device';

      // Extract brand from device name if it starts with brand name
      // Example: "Google Pixel 9 Pro XL" -> brand: "Google", name: "Pixel 9 Pro XL"
      if (brand && name.toLowerCase().startsWith(brand.toLowerCase())) {
        // Remove brand from the beginning of name
        name = name.substring(brand.length).trim();
      } else if (!brand && name) {
        // If no brand from API, try to extract from name (first word)
        const nameParts = name.split(' ');
        if (nameParts.length > 1) {
          brand = nameParts[0];
          name = nameParts.slice(1).join(' ');
        }
      }

      // Fallback if brand is still empty
      if (!brand) {
        brand = 'Unknown Brand';
      }

      // Extract properties (Storage, Color, etc.)
      const properties = device.properties || [];
      const storage = properties.find(p => p.group?.name === 'Storage')?.name || '';
      const color = properties.find(p => p.group?.name === 'Color')?.name || '';
      const fullName = storage ? `${name} (${storage})` : name;

      // Pricing
      const calculatedPrice = device.calculatedPrice || device.calculatedCheapestPrice;
      const currentPrice = calculatedPrice?.unitPrice || calculatedPrice?.totalPrice || device.price?.[0]?.gross || 0;
      const listPrice = calculatedPrice?.listPrice?.price || device.price?.[0]?.listPrice || device.listPrice || null;
      const originalPrice = listPrice;

      // Calculate discount
      let discountPctg = 0;
      if (originalPrice && originalPrice > currentPrice) {
        discountPctg = Math.round(((originalPrice - currentPrice) / originalPrice) * 100);
      } else if (calculatedPrice?.listPrice?.percentage) {
        discountPctg = Math.round(calculatedPrice.listPrice.percentage);
      }

      // Format prices
      const formattedCurrentPrice = currentPrice.toLocaleString('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
      const formattedOriginalPrice = originalPrice ? originalPrice.toLocaleString('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }) : null;

      // Image
      const coverImage = device.cover?.media?.url || device.media?.[0]?.media?.url || device.image || null;

      // Financing (default value from design)
      const monthlyPayment = 15.00;
      const formattedMonthly = monthlyPayment.toLocaleString('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });

      // Device Specs
      const weight = device.weight;
      const width = device.width;
      const height = device.height;
      const length = device.length;
      const dimensions = width && height && length 
        ? `${width} √ó ${height} √ó ${length} mm`
        : null;

      // Stock information
      const stock = device.stock;
      const availableStock = device.availableStock;
      const isAvailable = device.available !== false;
      let stockStatus = '';
      let stockClass = '';
      if (stock !== undefined) {
        if (stock > 5) {
          stockStatus = `In Stock (${stock} available)`;
          stockClass = 'stock-available';
        } else if (stock > 0) {
          stockStatus = `Low Stock (${stock} left)`;
          stockClass = 'stock-low';
        } else {
          stockStatus = 'Out of Stock';
          stockClass = 'stock-out';
        }
      } else if (isAvailable) {
        stockStatus = 'Available';
        stockClass = 'stock-available';
      }

      // Release date
      const releaseDate = device.releaseDate;
      const formattedReleaseDate = releaseDate 
        ? new Date(releaseDate).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })
        : null;

      // Product numbers
      const productNumber = device.productNumber || '';
      const manufacturerNumber = device.manufacturerNumber || '';

      return `
        <div class="device-card">
          <div class="device-brand">${brand}</div>
          <div class="device-name">${fullName}</div>
          
          <div class="device-image-container">
            ${coverImage ?
          `<img src="${coverImage}" alt="${name}" class="device-image" onerror="this.parentElement.innerHTML='<div class=\\'device-image-placeholder\\'>üì±</div>'">` :
          `<div class="device-image-placeholder">üì±</div>`
        }
          </div>
          
          <div class="device-pricing">
            <div class="price-row">
              ${formattedOriginalPrice ? `<span class="original-price">${formattedOriginalPrice}</span>` : ''}
              <span class="current-price">${formattedCurrentPrice}</span>
            </div>
            ${discountPctg > 0 ? `<div class="discount-badge">${discountPctg}% Off</div>` : ''}
          </div>
          
          <div class="financing-option">
            or as low as ${formattedMonthly}/mo with <span class="financing-logo"></span> TERRACE FINANCE
          </div>
          
          ${(dimensions || weight || color || stockStatus || releaseDate) ? `
          <div class="device-specs">
            <div class="specs-grid">
              ${dimensions ? `
              <div class="spec-item">
                <div class="spec-label">Dimensions</div>
                <div class="spec-value">${dimensions}</div>
              </div>
              ` : ''}
              ${weight ? `
              <div class="spec-item">
                <div class="spec-label">Weight</div>
                <div class="spec-value">${weight} g</div>
              </div>
              ` : ''}
              ${color ? `
              <div class="spec-item">
                <div class="spec-label">Color</div>
                <div class="spec-value">${color}</div>
              </div>
              ` : ''}
              ${releaseDate ? `
              <div class="spec-item">
                <div class="spec-label">Release Date</div>
                <div class="spec-value">${formattedReleaseDate}</div>
              </div>
              ` : ''}
            </div>
            ${stockStatus ? `
            <div class="stock-info ${stockClass}" style="margin-top: 8px;">
              ${stockClass === 'stock-available' ? '‚úÖ' : stockClass === 'stock-low' ? '‚ö†Ô∏è' : '‚ùå'} ${stockStatus}
            </div>
            ` : ''}
          </div>
          ` : ''}

          ${(productNumber || manufacturerNumber) ? `
          <div class="device-meta">
            ${productNumber ? `<span>SKU: ${productNumber}</span>` : ''}
            ${manufacturerNumber ? `<span>Model: ${manufacturerNumber}</span>` : ''}
          </div>
          ` : ''}
          
          <button class="add-to-cart-btn" onclick="addDeviceToCart('${deviceId}', '${name.replace(/'/g, "\\'")}', ${currentPrice})" ${!isAvailable || (stock !== undefined && stock === 0) ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
            ${!isAvailable || (stock !== undefined && stock === 0) ? 'Out of Stock' : 'Add to Cart'}
          </button>
        </div>
      `;
    }

    // Shared helper function to populate chat input with prompt
    function sendPrompt(message) {
      if (!message) {
        console.error('sendPrompt called without message');
        return;
      }
      
      console.log('sendPrompt called with:', message);
      
      // Try openPromptInput first (populates input field)
      if (window.openai?.openPromptInput) {
        try {
          window.openai.openPromptInput(message);
          console.log('‚úÖ Prompt added to chat input:', message);
          return;
        } catch (e) {
          console.error('Error with openPromptInput:', e);
        }
      } 
      
      // Fallback to sendFollowUpMessage (sends immediately)
      if (window.openai?.sendFollowUpMessage) {
        try {
          // Ensure message is a string
          const promptText = String(message);
          // Try calling with object format first
          if (typeof window.openai.sendFollowUpMessage === 'function') {
            // Check if it expects an object with 'prompt' property
            const result = window.openai.sendFollowUpMessage({ prompt: promptText });
            console.log('‚úÖ Prompt sent via sendFollowUpMessage (object):', promptText);
            return;
          }
        } catch (e) {
          // If object format fails, try string format
          try {
            window.openai.sendFollowUpMessage(promptText);
            console.log('‚úÖ Prompt sent via sendFollowUpMessage (string):', promptText);
            return;
          } catch (e2) {
            console.error('Error with sendFollowUpMessage (both formats):', e, e2);
          }
        }
      } 
      
      // Last resort: show alert
      console.error('No prompt API available. Available keys:', window.openai ? Object.keys(window.openai) : 'window.openai not found');
      alert(`Action: ${message}\n\nPlease type this in the chat and press Enter.`);
    }
    
    // Make functions available globally
    window.sendPrompt = sendPrompt;
    window.clearFilters = clearFilters;
    window.toggleEsimFilter = toggleEsimFilter;
    
    // Function to add device to cart
    function addDeviceToCart(deviceId, deviceName, price) {
      // Send prompt that will trigger add_to_cart tool
      sendPrompt(`Add ${deviceName} device to my cart`);
    }

    // Function to check if toolOutput has valid data
    function hasValidToolOutput() {
      if (!window.openai) return false;

      const toolOutput = window.openai.toolOutput;
      if (toolOutput && toolOutput !== null && typeof toolOutput === 'object') {
        if (toolOutput.devices && Array.isArray(toolOutput.devices) && toolOutput.devices.length > 0) {
          return true;
        }
        if (toolOutput.structuredContent && toolOutput.structuredContent.devices &&
          Array.isArray(toolOutput.structuredContent.devices) && toolOutput.structuredContent.devices.length > 0) {
          return true;
        }
      }

      const metadata = window.openai.toolResponseMetadata;
      if (metadata && metadata !== null && typeof metadata === 'object') {
        if (metadata.devices && Array.isArray(metadata.devices) && metadata.devices.length > 0) {
          return true;
        }
      }

      return false;
    }

    // Function to extract devices from toolOutput
    function extractDevices() {
      if (!window.openai) {
        console.log('‚ùå window.openai not available');
        return [];
      }

      let toolOutput = window.openai.toolOutput;
      console.log('üîç Checking toolOutput:', {
        exists: !!toolOutput,
        isNull: toolOutput === null,
        type: typeof toolOutput,
        keys: toolOutput ? Object.keys(toolOutput) : []
      });

      if (toolOutput && toolOutput !== null && typeof toolOutput === 'object') {
        if (toolOutput.devices && Array.isArray(toolOutput.devices)) {
          console.log('‚úÖ Found devices in toolOutput.devices:', toolOutput.devices.length);
          return toolOutput.devices;
        }
        if (toolOutput.structuredContent && toolOutput.structuredContent.devices && Array.isArray(toolOutput.structuredContent.devices)) {
          console.log('‚úÖ Found devices in toolOutput.structuredContent.devices:', toolOutput.structuredContent.devices.length);
          return toolOutput.structuredContent.devices;
        }
      }

      const metadata = window.openai.toolResponseMetadata;
      if (metadata && metadata !== null && typeof metadata === 'object') {
        console.log('üîç Checking toolResponseMetadata:', Object.keys(metadata));
        if (metadata.devices && Array.isArray(metadata.devices)) {
          console.log('‚úÖ Found devices in toolResponseMetadata.devices:', metadata.devices.length);
          return metadata.devices;
        }
      }

      console.log('‚ùå No devices found in any location');
      return [];
    }

    // Store all devices for filtering
    let allDevices = [];

    // Filter functions
    function getDevicePrice(device) {
      // Try multiple price fields in order of preference
      if (device?.calculatedPrice?.unitPrice) return device.calculatedPrice.unitPrice;
      if (device?.calculatedPrice?.totalPrice) return device.calculatedPrice.totalPrice;
      if (device?.calculatedCheapestPrice?.unitPrice) return device.calculatedCheapestPrice.unitPrice;
      if (device?.calculatedCheapestPrice?.totalPrice) return device.calculatedCheapestPrice.totalPrice;
      if (device?.price?.[0]?.gross) return device.price[0].gross;
      if (typeof device?.price === 'number') return device.price;
      return 0;
    }

    function isEsimCapable(device) {
      if (!device) return false;

      // Check boolean/flag fields
      const flagCandidates = [
        device.esimAvailable,
        device.eSimAvailable,
        device.esimCapable,
        device.supportsEsim,
        device.esim_capable,
        device.eSIMCapable
      ];

      if (flagCandidates.some(v => v === true || v === "true" || v === "Y" || v === "YES")) {
        return true;
      }

      // Check properties array
      const props = device.properties || [];
      const propsText = JSON.stringify(props).toLowerCase();
      if (propsText.includes("esim") || propsText.includes("e-sim")) {
        return true;
      }

      // Check full device object
      const fullText = JSON.stringify(device).toLowerCase();
      return fullText.includes("esim") || fullText.includes("e-sim");
    }

    function filterDevices() {
      const searchQuery = document.getElementById('filter-search')?.value.toLowerCase().trim() || '';
      const brandFilter = document.getElementById('filter-brand')?.value || '';
      const maxPrice = parseFloat(document.getElementById('filter-price')?.value) || null;
      const esimOnly = document.getElementById('filter-esim')?.checked || false;

      let filtered = [...allDevices];

      // Text search filter
      if (searchQuery) {
        filtered = filtered.filter(device => {
          const name = (device.name || device.translated?.name || '').toLowerCase();
          const brand = (device.manufacturer?.name || device.brand || device.translated?.manufacturer?.name || '').toLowerCase();
          const full = `${name} ${brand}`;
          return full.includes(searchQuery);
        });
      }

      // Brand filter
      if (brandFilter) {
        const brandLower = brandFilter.toLowerCase();
        const normalizedBrand = brandLower.includes('iphone') || brandLower.includes('apple') ? 'apple' :
                               brandLower.includes('samsung') || brandLower.includes('galaxy') ? 'samsung' :
                               brandLower.includes('pixel') || brandLower.includes('google') ? 'google' : brandLower;

        filtered = filtered.filter(device => {
          const deviceName = (device.name || device.translated?.name || '').toLowerCase();
          const deviceBrand = (device.manufacturer?.name || device.brand || device.translated?.manufacturer?.name || '').toLowerCase();

          if (normalizedBrand === 'apple') {
            return deviceName.includes('iphone') || deviceBrand.includes('apple');
          } else if (normalizedBrand === 'samsung') {
            return deviceName.includes('samsung') || deviceName.includes('galaxy') || deviceBrand.includes('samsung');
          } else if (normalizedBrand === 'google') {
            return deviceName.includes('pixel') || deviceBrand.includes('google');
          } else {
            return deviceName.includes(normalizedBrand) || deviceBrand.includes(normalizedBrand);
          }
        });
      }

      // Price filter
      if (maxPrice !== null && maxPrice > 0) {
        filtered = filtered.filter(device => {
          const price = getDevicePrice(device);
          return typeof price === 'number' && price <= maxPrice;
        });
      }

      // eSIM filter
      if (esimOnly) {
        filtered = filtered.filter(device => isEsimCapable(device));
      }

      return filtered;
    }

    function updateFilterUI() {
      const devices = extractDevices();
      if (devices.length === 0) return;

      allDevices = devices;
      const filtersContainer = document.getElementById('filters-container');
      const brandSelect = document.getElementById('filter-brand');

      // Extract unique brands
      const brandSet = new Set();
      devices.forEach(device => {
        const brandName = device.manufacturer?.name || device.brand || device.translated?.manufacturer?.name || null;
        if (brandName) {
          brandSet.add(brandName);
        }
      });

      // Populate brand dropdown
      const brands = Array.from(brandSet).sort();
      brandSelect.innerHTML = '<option value="">All Brands</option>';
      brands.forEach(brand => {
        const option = document.createElement('option');
        option.value = brand;
        option.textContent = brand;
        brandSelect.appendChild(option);
      });

      // Show filters container
      if (filtersContainer) {
        filtersContainer.style.display = 'block';
      }

      // Set up filter event listeners
      document.getElementById('filter-search')?.addEventListener('input', applyFilters);
      document.getElementById('filter-brand')?.addEventListener('change', applyFilters);
      document.getElementById('filter-price')?.addEventListener('input', applyFilters);
      document.getElementById('filter-esim')?.addEventListener('change', applyFilters);
    }

    function toggleEsimFilter() {
      const checkbox = document.getElementById('filter-esim');
      if (checkbox) {
        checkbox.checked = !checkbox.checked;
        applyFilters();
      }
    }

    function applyFilters() {
      const container = document.getElementById('devices-container');
      const resultsDiv = document.getElementById('filter-results');
      
      if (!container) return;

      const filtered = filterDevices();

      // Update results count
      if (resultsDiv) {
        const activeFilters = [];
        if (document.getElementById('filter-search')?.value.trim()) activeFilters.push('search');
        if (document.getElementById('filter-brand')?.value) activeFilters.push('brand');
        if (document.getElementById('filter-price')?.value) activeFilters.push('price');
        if (document.getElementById('filter-esim')?.checked) activeFilters.push('eSIM');

        if (activeFilters.length > 0) {
          resultsDiv.innerHTML = `Showing <strong>${filtered.length}</strong> of <strong>${allDevices.length}</strong> devices`;
        } else {
          resultsDiv.innerHTML = `Showing <strong>${allDevices.length}</strong> devices`;
        }
      }

      // Render filtered devices
      if (filtered.length === 0) {
        container.innerHTML = `
          <div class="no-results">
            <div class="no-results-title">No devices found</div>
            <div class="no-results-text">Try adjusting your filters to see more results.</div>
            <button class="clear-filters-btn" onclick="clearFilters()">Clear All Filters</button>
          </div>
        `;
      } else {
        const devicesHtml = filtered.map(renderDevice).join('');
        container.innerHTML = devicesHtml;
      }
    }

    function clearFilters() {
      document.getElementById('filter-search').value = '';
      document.getElementById('filter-brand').value = '';
      document.getElementById('filter-price').value = '';
      document.getElementById('filter-esim').checked = false;
      applyFilters();
    }

    // Function to render all devices
    function renderAllDevices() {
      const container = document.getElementById('devices-container');
      if (!container) {
        console.error('Devices container not found');
        return false;
      }

      const devices = extractDevices();

      if (devices.length === 0) {
        return false;
      } else {
        // Store devices and set up filters
        allDevices = devices;
        updateFilterUI();
        
        // Render all devices initially
        const devicesHtml = devices.map(renderDevice).join('');
        container.innerHTML = devicesHtml;
        
        // Update results count
        const resultsDiv = document.getElementById('filter-results');
        if (resultsDiv) {
          resultsDiv.innerHTML = `Showing <strong>${devices.length}</strong> devices`;
        }
        
        return true;
      }
    }

    // Permanent solution: Watch for toolOutput changing from null to data
    let rendered = false;
    let lastToolOutputValue = null;
    let checkCount = 0;
    const maxChecks = 500; // Check for up to 25 seconds (500 * 50ms)

    // Very fast polling to detect when toolOutput changes from null to data
    function watchForToolOutputChange() {
      if (rendered) return;

      checkCount++;

      if (hasValidToolOutput()) {
        const success = renderAllDevices();
        if (success) {
          console.log('‚úÖ Devices rendered successfully (toolOutput populated)');
          rendered = true;
          return;
        }
      }

      const currentValue = window.openai?.toolOutput;
      if (currentValue !== lastToolOutputValue) {
        lastToolOutputValue = currentValue;

        if (currentValue !== null && currentValue !== undefined) {
          console.log('toolOutput changed from null to:', typeof currentValue);
          const success = renderAllDevices();
          if (success) {
            console.log('‚úÖ Devices rendered (value change detected)');
            rendered = true;
            return;
          }
        }
      }

      if (!rendered && checkCount < maxChecks) {
        setTimeout(watchForToolOutputChange, 50);
      } else if (!rendered && checkCount >= maxChecks) {
        const debugInfo = window.openai ?
          `<p style="padding: 10px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; margin: 10px 0;">
            <strong>Debug Info:</strong><br>
            window.openai exists: ‚úÖ<br>
            toolOutput exists: ${window.openai.toolOutput ? '‚úÖ' : '‚ùå'}<br>
            toolResponseMetadata exists: ${window.openai.toolResponseMetadata ? '‚úÖ' : '‚ùå'}<br>
            Available keys: ${Object.keys(window.openai).join(', ')}<br>
            toolOutput value: ${JSON.stringify(window.openai.toolOutput || 'null', null, 2)}
          </p>` :
          '<p style="padding: 10px; background: #f8d7da; border: 1px solid #dc3545; border-radius: 4px; margin: 10px 0;"><strong>Error:</strong> window.openai is not available</p>';

        container.innerHTML = debugInfo + '<p style="padding: 20px; text-align: center; color: #d32f2f;">‚ö†Ô∏è Unable to load devices. Please try again.</p>';
      }
    }

    // Try to intercept toolOutput property changes using Proxy/defineProperty
    function setupToolOutputWatcher() {
      if (!window.openai) {
        setTimeout(setupToolOutputWatcher, 100);
        return;
      }

      try {
        let currentValue = window.openai.toolOutput;

        Object.defineProperty(window.openai, 'toolOutput', {
          get: function () {
            return currentValue;
          },
          set: function (newValue) {
            currentValue = newValue;

            if (newValue !== null && newValue !== undefined &&
              typeof newValue === 'object') {

              console.log('‚úÖ toolOutput changed from null to data!', newValue);

              setTimeout(() => {
                if (!rendered) {
                  const success = renderAllDevices();
                  if (success) {
                    rendered = true;
                    console.log('‚úÖ Devices rendered (property setter detected)');
                  }
                }
              }, 10);
            }
          },
          configurable: true,
          enumerable: true
        });

        console.log('‚úÖ Set up toolOutput property watcher');
      } catch (e) {
        console.warn('Could not set up property watcher (this is OK, using polling instead):', e.message);
      }
    }

    // Start the permanent solution immediately
    setupToolOutputWatcher();
    watchForToolOutputChange();

    // Also listen for load event as fallback
    window.addEventListener("load", () => {
      console.log('üì• Load event fired, attempting to render devices');
      if (!rendered) {
        const success = renderAllDevices();
        if (success) {
          rendered = true;
          console.log('‚úÖ Devices rendered on load event');
        }
      }
    });

    // Also try on DOMContentLoaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        console.log('üì• DOMContentLoaded fired, attempting to render devices');
        if (!rendered) {
          const success = renderAllDevices();
          if (success) {
            rendered = true;
            console.log('‚úÖ Devices rendered on DOMContentLoaded');
          }
        }
      });
    } else {
      console.log('üì• DOM already loaded, attempting immediate render');
      if (!rendered) {
        const success = renderAllDevices();
        if (success) {
          rendered = true;
          console.log('‚úÖ Devices rendered (DOM already loaded)');
        }
      }
    }
  </script>
</body>

</html>