<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shopping Cart</title>
  <meta http-equiv="Content-Security-Policy"
    content="img-src 'self' data: https://shopware-api-nctc-qa.reachmobileplatform.com https://cdn.tailwindcss.com https://cdn.jsdelivr.net https://unpkg.com https://*.oaiusercontent.com https://threejs.org;">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary-green: #30ba95;
      --primary-green-hover: #269678;
      --button-radius: 8px;
      --button-padding: 14px 22px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      padding: 16px;
      background: #f5f5f5;
    }

    .cart-header {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 24px;
      color: #023d1a;
      text-align: center;
    }

    .lines-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 24px;
      max-width: 1400px;
      margin: 0 auto 32px;
    }

    .line-card {
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 24px;
      background: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .line-card:hover {
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
      transform: translateY(-2px);
    }

    .line-header {
      font-size: 20px;
      font-weight: bold;
      color: #023d1a;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid #30ba95;
    }

    .item-section {
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid #e0e0e0;
    }

    .item-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    .item-label {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .item-content {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      flex-wrap: nowrap;
    }

    @media (max-width: 600px) {
      .item-content {
        flex-wrap: wrap;
      }
    }

    .item-name {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      flex: 1;
    }

    .item-price {
      font-size: 18px;
      font-weight: bold;
      color: #30ba95;
      white-space: nowrap;
      text-align: right;
      min-width: 80px;
    }

    .item-missing {
      color: #ff9800;
      font-weight: 600;
    }

    .item-optional {
      color: #999;
      font-style: italic;
    }

    .item-details {
      font-size: 13px;
      color: #666;
      margin-top: 6px;
      line-height: 1.5;
      word-wrap: break-word;
    }

    .sim-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      background: #ecfdf5;
      color: #30ba95;
      border: 1px solid #30ba95;
    }

    .sim-badge.missing {
      background: #fff3e0;
      color: #ff9800;
      border-color: #ff9800;
    }

    .line-total {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 2px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 18px;
      font-weight: bold;
      color: #023d1a;
    }

    .summary-section {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border: 2px solid #e0e0e0;
    }

    .summary-title {
      font-size: 20px;
      font-weight: bold;
      color: #023d1a;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid #30ba95;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      font-size: 16px;
      border-bottom: 1px solid #e0e0e0;
    }

    .summary-row:last-child {
      border-bottom: none;
    }

    .summary-label {
      color: #666;
    }

    .summary-value {
      font-weight: 600;
      color: #333;
    }

    .summary-total {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 2px solid #30ba95;
      font-size: 24px;
      font-weight: bold;
      color: #023d1a;
    }

    .tax-note {
      font-size: 12px;
      color: #999;
      font-style: italic;
      margin-top: 8px;
    }

    .checkout-button {
      width: 100%;
      background: var(--primary-green);
      color: white;
      border: none;
      padding: var(--button-padding);
      border-radius: var(--button-radius);
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s ease;
      margin-top: 24px;
    }

    .checkout-button:hover {
      background: var(--primary-green-hover);
    }

    .empty-cart {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .empty-cart-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }

    .empty-cart-text {
      font-size: 18px;
      margin-bottom: 8px;
    }

    .empty-cart-subtext {
      font-size: 14px;
      color: #999;
    }
  </style>
</head>

<body>
  <div id="cart-container">
    <div style="padding: 40px; text-align: center; color: #666; font-size: 18px;">
      <div style="margin-bottom: 10px;">‚è≥</div>
      <div>Loading cart...</div>
    </div>
  </div>

  <script>
    // Function to render a single line card
    function renderLineCard(line, index) {
      const lineNumber = line.lineNumber || (index + 1);
      let monthlyTotal = 0;
      let deviceTotal = 0;
      let protectionTotal = 0;

      // Plan section - Show all API fields if available
      let planHtml = '';
      if (line.plan) {
        monthlyTotal += line.plan.price || 0;

        // Get all available API fields
        const planName = line.plan.name || line.plan.displayName || line.plan.displayNameWeb || 'Plan';
        const planPrice = line.plan.price || line.plan.baseLinePrice || 0;
        const planData = line.plan.data || line.plan.planData;
        const dataUnit = line.plan.dataUnit || 'GB';
        const isUnlimited = line.plan.unlimited || line.plan.isUnlimited;
        const planType = line.plan.planType;
        const maxLines = line.plan.maxLines;
        const additionalLinePrice = line.plan.additionalLinePrice;
        const discountPctg = line.plan.discountPctg;
        const planCharging = line.plan.planCharging;
        const serviceCode = line.plan.serviceCode;
        const description = line.plan.description;

        // Only add details that have actual values
        let planDetails = [];
        if (isUnlimited) planDetails.push('Unlimited data');
        if (planData && !isUnlimited && planData !== '' && planData !== null && planData !== undefined) planDetails.push(`${planData}${dataUnit} high-speed data`);
        if (planType && planType.trim() !== '') planDetails.push(`Type: ${planType}`);
        if (maxLines && maxLines > 0) planDetails.push(`Up to ${maxLines} lines`);
        if (additionalLinePrice && additionalLinePrice > 0) planDetails.push(`Additional lines: $${additionalLinePrice}/mo`);
        if (discountPctg && discountPctg > 0) planDetails.push(`${discountPctg}% discount`);
        if (planCharging && planCharging.trim() !== '') planDetails.push(`Charging: ${planCharging}`);
        if (serviceCode && serviceCode.trim() !== '') planDetails.push(`Service: ${serviceCode}`);

        planHtml = `
          <div class="item-section">
            <div class="item-label">üì± Mobile Plan</div>
            <div class="item-content">
              <div style="flex: 1;">
                <div class="item-name">${planName}</div>
                ${planDetails.length > 0 ? `<div class="item-details">${planDetails.join(' ‚Ä¢ ')}</div>` : ''}
                ${description && description.trim() !== '' ? `<div class="item-details" style="margin-top: 4px; font-style: italic;">${description}</div>` : ''}
              </div>
              <div class="item-price">$${planPrice.toFixed(2)}/mo</div>
            </div>
          </div>
        `;
      } else {
        planHtml = `
          <div class="item-section">
            <div class="item-label">üì± Mobile Plan</div>
            <div class="item-content">
              <div class="item-name item-missing">‚ö†Ô∏è Not selected (required)</div>
              <div class="item-price item-missing">-</div>
            </div>
          </div>
        `;
      }

      // Device section - Show all API fields if available (only show if device data exists)
      let deviceHtml = '';
      if (line.device && (line.device.id || line.device.name || line.device.price !== undefined)) {
        deviceTotal += line.device.price || 0;

        // Get all available API fields
        const deviceName = line.device.name || line.device.translated?.name || 'Device';
        const deviceBrand = line.device.brand || line.device.manufacturer?.name || line.device.translated?.manufacturer?.name || line.device.customFields?.brand || '';
        const devicePrice = line.device.price || line.device.calculatedPrice?.unitPrice || line.device.calculatedPrice?.totalPrice || 0;
        const deviceImage = line.device.image || line.device.cover?.media?.url || (line.device.media && line.device.media[0]?.media?.url) || line.device.coverImage || line.device.thumbnail;
        const listPrice = line.device.calculatedPrice?.listPrice?.price;
        const available = line.device.available;

        // Extract device specs from customFields (preferred) or properties
        const properties = line.device.properties || [];
        const customFields = line.device.customFields || line.device.translated?.customFields || {};

        const storage = customFields.storage_capacity ||
          properties.find(p => p.group?.name === 'Storage' || p.group?.name === 'storage')?.name || '';
        const color = customFields.design_color ||
          properties.find(p => p.group?.name === 'Color' || p.group?.name === 'color')?.name || '';
        const condition = customFields.condition ||
          properties.find(p => p.group?.name === 'Condition' || p.group?.name === 'condition')?.name ||
          line.device.condition || '';

        // Extract additional specs from customFields
        const ram = customFields.ram_capacity || '';
        const display = customFields.display_type || customFields.display_resolution || '';
        const camera = customFields.back_camera_resolution || customFields.front_camera_resolution || '';
        const battery = customFields.battery_capacity || '';

        // Build device specs array (only include non-empty values, NO SKU/ID)
        let deviceSpecs = [];
        if (storage && storage.trim() !== '') deviceSpecs.push(storage);
        if (color && color.trim() !== '') deviceSpecs.push(color);
        if (display && display.trim() !== '') deviceSpecs.push(display);
        if (ram && ram.trim() !== '') deviceSpecs.push(ram);
        if (camera && camera.trim() !== '') {
          // Simplify camera description if too long
          const cameraShort = camera.length > 30 ? camera.substring(0, 30) + '...' : camera;
          deviceSpecs.push(cameraShort);
        }
        if (battery && battery.trim() !== '') deviceSpecs.push(battery);
        if (condition && condition.trim() !== '' && condition.toLowerCase() !== 'new') deviceSpecs.push(condition);

        // Build device name - only include brand if it exists and not already in name
        let displayName = deviceName;
        if (deviceBrand && deviceBrand.trim() !== '') {
          // Check if brand is already in device name to avoid duplication (e.g., "Google Google Pixel")
          const brandLower = deviceBrand.toLowerCase().trim();
          const nameLower = deviceName.toLowerCase().trim();
          if (!nameLower.startsWith(brandLower)) {
            displayName = `${deviceBrand} ${deviceName}`;
          }
        }

        deviceHtml = `
          <div class="item-section">
            <div class="item-label">üì± Device</div>
            <div class="item-content">
              <div style="flex: 1; display: flex; align-items: center; gap: 16px; min-width: 0;">
                <div style="flex-shrink: 0; width: 80px; height: 80px; position: relative;">
                  ${deviceImage ? `
                    <img src="${deviceImage}" 
                         alt="${deviceName}" 
                         style="width: 100%; height: 100%; object-fit: contain; border-radius: 8px; background: #f5f5f5; padding: 4px; display: block;"
                         onerror="this.onerror=null; this.style.display='none'; const placeholder = this.parentElement.querySelector('.device-image-placeholder'); if(placeholder) placeholder.style.display='flex';">
                    <div class="device-image-placeholder" style="width: 100%; height: 100%; border-radius: 8px; background: #f5f5f5; display: none; align-items: center; justify-content: center; color: #999; font-size: 32px; position: absolute; top: 0; left: 0;">üì±</div>
                  ` : `
                    <div style="width: 100%; height: 100%; border-radius: 8px; background: #f5f5f5; display: flex; align-items: center; justify-content: center; color: #999; font-size: 32px;">üì±</div>
                  `}
                </div>
                <div style="flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 4px;">
                  <div class="item-name" style="word-break: break-word;">${displayName}</div>
                  ${deviceSpecs.length > 0 ? `<div class="item-details" style="line-height: 1.4;">${deviceSpecs.join(' ‚Ä¢ ')}</div>` : ''}
                  ${available === false ? `<div class="item-details" style="color: #ff9800; margin-top: 2px;">‚ö†Ô∏è Limited availability</div>` : ''}
                </div>
              </div>
              <div style="text-align: right; flex-shrink: 0; margin-left: 16px; align-self: flex-start;">
                ${listPrice && listPrice > devicePrice ? `<div style="font-size: 12px; color: #999; text-decoration: line-through; margin-bottom: 2px;">$${listPrice.toFixed(2)}</div>` : ''}
                <div class="item-price">$${devicePrice.toFixed(2)}</div>
              </div>
            </div>
          </div>
        `;
      }

      // Protection section - Only show if protection data exists (optional field)
      let protectionHtml = '';
      if (line.protection &&
        line.protection !== null &&
        line.protection !== undefined &&
        typeof line.protection === 'object' &&
        (line.protection.id || line.protection.name || (line.protection.price !== undefined && line.protection.price !== null))) {
        protectionTotal += line.protection.price || 0;

        // Get all available API fields
        const protectionName = line.protection.name || 'Protection Plan';
        const protectionPrice = line.protection.price || 0;
        const deductible = line.protection.deductible;
        const coverage = line.protection.coverage;
        const highlights = line.protection.highlights || [];
        const billingCycle = line.protection.billingCycle;
        const isMonthly = billingCycle === 'monthly' || (billingCycle === undefined && protectionPrice < 100);

        // Only add details that have actual values
        let protectionDetails = [];
        if (deductible && deductible !== '' && deductible !== null && deductible !== undefined) protectionDetails.push(`Deductible: $${deductible}`);
        if (coverage && coverage.trim() !== '') protectionDetails.push(`Coverage: ${coverage}`);
        if (highlights && highlights.length > 0 && highlights.filter(h => h && h.trim() !== '').length > 0) {
          const validHighlights = highlights.filter(h => h && h.trim() !== '').slice(0, 2);
          if (validHighlights.length > 0) protectionDetails.push(validHighlights.join(', '));
        }

        protectionHtml = `
          <div class="item-section">
            <div class="item-label">üõ°Ô∏è Device Protection</div>
            <div class="item-content">
              <div style="flex: 1;">
                <div class="item-name">${protectionName}</div>
                ${protectionDetails.length > 0 ? `<div class="item-details">${protectionDetails.join(' ‚Ä¢ ')}</div>` : ''}
                ${highlights && highlights.length > 2 && highlights.filter(h => h && h.trim() !== '').length > 2 ? `<div class="item-details" style="margin-top: 4px; font-size: 12px;">+ ${highlights.filter(h => h && h.trim() !== '').length - 2} more features</div>` : ''}
              </div>
              <div class="item-price">$${protectionPrice.toFixed(2)}${isMonthly ? '/mo' : ''}</div>
            </div>
          </div>
        `;
      }

      // SIM section - Show all API fields if available
      let simHtml = '';
      if (line.sim && line.sim.simType) {
        // Get all available API fields
        const simType = line.sim.simType === 'ESIM' ? 'eSIM' : (line.sim.simType === 'PSIM' ? 'Physical SIM' : line.sim.simType);
        const iccId = line.sim.iccId;
        const isEsim = line.sim.simType === 'ESIM';

        let simDetails = [];
        if (isEsim) {
          simDetails.push('‚ö° Instant activation');
          simDetails.push('No shipping required');
        } else {
          simDetails.push('üì¶ Physical card shipped');
          simDetails.push('Standard shipping');
        }
        if (iccId && iccId.trim() !== '') simDetails.push(`ICCID: ${iccId}`);

        simHtml = `
          <div class="item-section">
            <div class="item-label">üì≤ SIM Card</div>
            <div class="item-content">
              <div style="flex: 1;">
                <div style="margin-bottom: 8px;">
                  <span class="sim-badge">${simType}</span>
                </div>
                ${simDetails.length > 0 ? `<div class="item-details">${simDetails.join(' ‚Ä¢ ')}</div>` : ''}
              </div>
              <div class="item-price" style="color: #666;">Free</div>
            </div>
          </div>
        `;
      } else {
        simHtml = `
          <div class="item-section">
            <div class="item-label">üì≤ SIM Card</div>
            <div class="item-content">
              <div>
                <span class="sim-badge missing">‚ö†Ô∏è Not selected (required)</span>
                <div class="item-details" style="margin-top: 8px; color: #ff9800;">Choose eSIM or Physical SIM</div>
              </div>
              <div class="item-price item-missing">-</div>
            </div>
          </div>
        `;
      }

      // Calculate line total
      const lineTotal = monthlyTotal + deviceTotal + protectionTotal;

      return `
        <div class="line-card">
          <div class="line-header">Line ${lineNumber}</div>
          ${planHtml}
          ${deviceHtml}
          ${protectionHtml}
          ${simHtml}
          <div class="line-total">
            <span>Line ${lineNumber} Total</span>
            <span>$${lineTotal.toFixed(2)}${monthlyTotal > 0 ? '/mo' : ''}</span>
          </div>
        </div>
      `;
    }

    // Function to render summary section
    function renderSummary(monthlyTotal, deviceTotal, protectionTotal, oneTimeTotal, totalDueToday) {
      const subtotal = deviceTotal + protectionTotal;
      const hasMonthlyCharges = monthlyTotal > 0;
      const hasOneTimeCharges = subtotal > 0 || oneTimeTotal > 0;

      return `
        <div class="summary-section">
          <div class="summary-title">üí∞ Order Summary</div>
          
          ${hasMonthlyCharges ? `
            <div style="margin-bottom: 16px; padding-bottom: 16px; border-bottom: 2px solid #e0e0e0;">
              <div style="font-size: 14px; color: #666; margin-bottom: 12px; font-weight: 600;">Monthly Recurring Charges</div>
          ${monthlyTotal > 0 ? `
            <div class="summary-row">
                  <span class="summary-label">Monthly Plan Charges</span>
              <span class="summary-value">$${monthlyTotal.toFixed(2)}/mo</span>
                </div>
              ` : ''}
              <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e0e0e0;">
                <div class="summary-row" style="font-weight: 600;">
                  <span class="summary-label">Monthly Total</span>
                  <span class="summary-value">$${monthlyTotal.toFixed(2)}/mo</span>
                </div>
              </div>
            </div>
          ` : ''}
          
          ${hasOneTimeCharges ? `
            <div style="margin-bottom: 16px; padding-bottom: 16px; border-bottom: 2px solid #e0e0e0;">
              <div style="font-size: 14px; color: #666; margin-bottom: 12px; font-weight: 600;">One-Time Charges</div>
          ${deviceTotal > 0 ? `
            <div class="summary-row">
                  <span class="summary-label">Device(s)</span>
              <span class="summary-value">$${deviceTotal.toFixed(2)}</span>
            </div>
          ` : ''}
          ${protectionTotal > 0 ? `
            <div class="summary-row">
                  <span class="summary-label">Protection Plan(s)</span>
              <span class="summary-value">$${protectionTotal.toFixed(2)}</span>
            </div>
          ` : ''}
              ${subtotal > 0 ? `
                <div class="summary-row" style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e0e0e0;">
                  <span class="summary-label">Subtotal</span>
                  <span class="summary-value">$${subtotal.toFixed(2)}</span>
                </div>
              ` : ''}
          <div class="summary-row">
                <span class="summary-label">Handling Fee</span>
            <span class="summary-value">$10.00</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Shipping & Handling</span>
            <span class="summary-value">$15.00</span>
          </div>
            </div>
          ` : ''}
          
          <div class="tax-note" style="margin-bottom: 16px;">
            <strong>Note:</strong> Taxes, regulatory fees, and other charges will be calculated during checkout based on your location.
          </div>
          
          ${hasOneTimeCharges ? `
          <div class="summary-row summary-total">
            <span>Total Due Today</span>
            <span>$${totalDueToday.toFixed(2)}</span>
          </div>
          ` : ''}
          
          ${hasMonthlyCharges && !hasOneTimeCharges ? `
            <div class="summary-row summary-total">
              <span>First Month Total</span>
              <span>$${monthlyTotal.toFixed(2)}</span>
            </div>
          ` : ''}
          
          ${hasMonthlyCharges && hasOneTimeCharges ? `
            <div style="margin-top: 16px; padding-top: 16px; border-top: 2px solid #30ba95;">
              <div class="summary-row" style="font-size: 16px; margin-bottom: 8px;">
                <span class="summary-label">Due Today</span>
                <span class="summary-value">$${totalDueToday.toFixed(2)}</span>
              </div>
              <div class="summary-row" style="font-size: 14px; color: #666;">
                <span class="summary-label">Then $${monthlyTotal.toFixed(2)}/mo</span>
                <span class="summary-value"></span>
              </div>
            </div>
          ` : ''}
          
          <button class="checkout-button" onclick="proceedToCheckout()">
            Proceed to Checkout
          </button>
        </div>
      `;
    }

    // Function to render cart
    function renderCart(cart, sessionId) {
      const container = document.getElementById('cart-container');
      if (!container) {
        console.error('Cart container not found');
        return false;
      }

      // Check if cart uses multi-line structure
      const lines = cart.lines || [];
      const items = cart.items || [];

      // Show empty cart UI if cart is empty (but only if we have valid data)
      if (lines.length === 0 && items.length === 0) {
        container.innerHTML = `
          <div class="empty-cart">
            <div class="empty-cart-icon">üõí</div>
            <div class="empty-cart-text">Your cart is empty</div>
            <div class="empty-cart-subtext">Add plans or devices to get started!</div>
          </div>
        `;
        return true;
      }

      // Use multi-line structure if available
      if (lines.length > 0) {
        // Calculate totals
        let monthlyTotal = 0;
        let deviceTotal = 0;
        let protectionTotal = 0;

        lines.forEach(line => {
          if (line.plan) monthlyTotal += line.plan.price || 0;
          if (line.device) deviceTotal += line.device.price || 0;
          if (line.protection) protectionTotal += line.protection.price || 0;
        });

        const oneTimeTotal = 10.00 + 15.00; // Handling + shipping
        const totalDueToday = deviceTotal + protectionTotal + oneTimeTotal;

        // Render line cards
        const linesHtml = lines.map((line, index) => renderLineCard(line, index)).join('');

        // Render summary
        const summaryHtml = renderSummary(monthlyTotal, deviceTotal, protectionTotal, oneTimeTotal, totalDueToday);

        container.innerHTML = `
          <div class="cart-header">SUMMARY</div>
          <div class="lines-container">
            ${linesHtml}
          </div>
          ${summaryHtml}
        `;

        return true;
      }

      // Fall back to old structure (backward compatibility)
      if (items.length === 0) {
        container.innerHTML = `
          <div class="empty-cart">
            <div class="empty-cart-icon">üõí</div>
            <div class="empty-cart-text">Your cart is empty</div>
            <div class="empty-cart-subtext">Add plans or devices to get started!</div>
          </div>
        `;
        return true;
      }

      // Old structure rendering (simplified)
      container.innerHTML = `
        <div class="cart-header">SUMMARY</div>
        <div class="summary-section">
          <div class="summary-title">Cart Items</div>
          ${items.map(item => `
            <div class="summary-row">
              <span class="summary-label">${item.name || 'Item'}</span>
              <span class="summary-value">$${(item.price || 0).toFixed(2)}</span>
            </div>
          `).join('')}
          <div class="summary-row summary-total">
            <span>Total</span>
            <span>$${(cart.total || 0).toFixed(2)}</span>
          </div>
        </div>
      `;

      return true;
    }

    // Shared helper function to populate chat input with prompt
    function sendPrompt(message) {
      if (!message) {
        console.error('sendPrompt called without message');
        return;
      }

      console.log('sendPrompt called with:', message);

      // Try openPromptInput first (populates input field)
      if (window.openai?.openPromptInput) {
        try {
          window.openai.openPromptInput(message);
          console.log('‚úÖ Prompt added to chat input:', message);
          return;
        } catch (e) {
          console.error('Error with openPromptInput:', e);
        }
      }

      // Fallback to sendFollowUpMessage (sends immediately)
      if (window.openai?.sendFollowUpMessage) {
        try {
          // Ensure message is a string
          const promptText = String(message);
          // Try calling with object format first
          if (typeof window.openai.sendFollowUpMessage === 'function') {
            // Check if it expects an object with 'prompt' property
            const result = window.openai.sendFollowUpMessage({ prompt: promptText });
            console.log('‚úÖ Prompt sent via sendFollowUpMessage (object):', promptText);
            return;
          }
        } catch (e) {
          // If object format fails, try string format
          try {
            window.openai.sendFollowUpMessage(promptText);
            console.log('‚úÖ Prompt sent via sendFollowUpMessage (string):', promptText);
            return;
          } catch (e2) {
            console.error('Error with sendFollowUpMessage (both formats):', e, e2);
          }
        }
      }

      // Last resort: show alert
      console.error('No prompt API available. Available keys:', window.openai ? Object.keys(window.openai) : 'window.openai not found');
      alert(`Action: ${message}\n\nPlease type this in the chat and press Enter.`);
    }

    // Make sendPrompt available globally
    window.sendPrompt = sendPrompt;

    function proceedToCheckout() {
      sendPrompt('Review my cart and proceed to checkout');
    }

    // Make proceedToCheckout available globally
    window.proceedToCheckout = proceedToCheckout;

    // Function to check if toolOutput has valid data (including empty cart)
    function hasValidToolOutput() {
      if (!window.openai) return false;

      const toolOutput = window.openai.toolOutput;
      // If toolOutput exists and is an object (even if cart is empty/null), we have valid data
      if (toolOutput && toolOutput !== null && typeof toolOutput === 'object') {
        // If toolOutput is an object (even empty), it means we got a response
        // This could be an empty cart response, so we should render it
        return true;
      }

      // Also check metadata
      const metadata = window.openai.toolResponseMetadata;
      if (metadata && metadata !== null && typeof metadata === 'object') {
        return true;
      }

      return false;
    }

    // Function to extract cart data from toolOutput
    function extractCartData() {
      if (!window.openai) {
        console.log('extractCartData: window.openai not available');
        return { cart: { items: [], total: 0 }, sessionId: 'default' };
      }

      let toolOutput = window.openai.toolOutput;
      console.log('extractCartData: toolOutput =', toolOutput);

      if (toolOutput && toolOutput !== null && typeof toolOutput === 'object') {
        // Check if cart exists (even if empty/null)
        if (toolOutput.cart !== undefined) {
          const cart = toolOutput.cart || { lines: [], items: [], total: 0 };
          console.log('extractCartData: Found cart in toolOutput.cart, lines:', cart.lines?.length || 0, 'items:', cart.items?.length || 0);
          return {
            cart: cart,
            sessionId: toolOutput.sessionId || 'default'
          };
        }
        // Check structuredContent
        if (toolOutput.structuredContent) {
          if (toolOutput.structuredContent.cart !== undefined) {
            const cart = toolOutput.structuredContent.cart || { lines: [], items: [], total: 0 };
            console.log('extractCartData: Found cart in structuredContent, lines:', cart.lines?.length || 0, 'items:', cart.items?.length || 0);
            return {
              cart: cart,
              sessionId: toolOutput.structuredContent.sessionId || toolOutput.sessionId || 'default'
            };
          }
        }
      }

      const metadata = window.openai.toolResponseMetadata;
      if (metadata && metadata !== null && typeof metadata === 'object') {
        if (metadata.cart !== undefined) {
          const cart = metadata.cart || { lines: [], items: [], total: 0 };
          console.log('extractCartData: Found cart in toolResponseMetadata, lines:', cart.lines?.length || 0, 'items:', cart.items?.length || 0);
          return {
            cart: cart,
            sessionId: metadata.sessionId || 'default'
          };
        }
      }

      console.log('extractCartData: No cart data found, returning empty cart');
      return { cart: { lines: [], items: [], total: 0 }, sessionId: 'default' };
    }

    // Function to render all cart data
    function renderAllCart() {
      // TEMPORARY: Use dummy data for UI development
      const useDummyData = false; // Set to false to use real data

      if (useDummyData) {
        const dummyCart = {
          lines: [
            {
              lineNumber: 1,
              plan: {
                name: "Unlimited 10",
                displayName: "Unlimited 10",
                price: 25,
                data: 10,
                dataUnit: "GB",
                unlimited: false,
                planType: "HSD",
                maxLines: 25,
                additionalLinePrice: 25,
                discountPctg: 0,
                planCharging: "MIA",
                serviceCode: "USA"
              },
              device: {
                name: "iPhone 15 Pro Max",
                brand: "Apple",
                price: 1099,
                originalPrice: 1299,
                image: "https://shopware-api-nctc-qa.reachmobileplatform.com/media/25/6c/46/1730972224/bec9b5be978942e5a4f7743d5c80e1e3.jpg",
                storage: "256GB",
                color: "Natural Titanium",
                productNumber: "AP-5TM43LLA-A660-GEGE",
                available: true,
                availableStock: 11
              },
              protection: {
                name: "Premium Device Protection",
                price: 12.99,
                billingCycle: "monthly",
                deductible: 99,
                coverage: "Accidental damage, theft, loss",
                highlights: ["Screen repair", "Battery replacement", "Water damage coverage"]
              },
              sim: {
                simType: "ESIM",
                iccId: "8901260123456789012"
              }
            },
            {
              lineNumber: 2,
              plan: {
                name: "Essentials",
                displayName: "Essentials",
                price: 25,
                data: 5,
                dataUnit: "GB",
                unlimited: false,
                planType: "HSD",
                maxLines: 25,
                additionalLinePrice: 25,
                discountPctg: 0,
                planCharging: "MIA",
                serviceCode: "USA"
              },
              device: {
                name: "Google Pixel 9 Pro XL",
                brand: "Google",
                price: 699,
                originalPrice: 1099,
                image: "https://shopware-api-nctc-qa.reachmobileplatform.com/media/f6/5b/4c/1728034328/42733d29e6af46a4be0e95c9339ba99b.PNG",
                storage: "128GB",
                color: "Black",
                productNumber: "GO-GA05900US-A001-GEGE",
                available: true,
                availableStock: 8
              },
              protection: null,
              sim: {
                simType: "PSIM",
                iccId: null
              }
            },
            {
              lineNumber: 3,
              plan: {
                name: "By the Gig",
                displayName: "By the Gig",
                price: 15,
                data: 1,
                dataUnit: "GB",
                unlimited: false,
                planType: "HSD",
                maxLines: 25,
                additionalLinePrice: 15,
                discountPctg: 0,
                planCharging: "MIA",
                serviceCode: "USA"
              },
              device: null,
              protection: null,
              sim: {
                simType: "ESIM",
                iccId: null
              }
            }
          ],
          items: [],
          total: 0
        };

        const success = renderCart(dummyCart, 'dummy-session');
        return success;
      }

      // Only render if we have valid toolOutput (to distinguish loading from empty)
      if (!hasValidToolOutput()) {
        console.log('renderAllCart: No valid toolOutput yet, waiting...');
        return false;
      }

      const cartData = extractCartData();
      const success = renderCart(cartData.cart, cartData.sessionId);
      return success;
    }

    // Robust loading mechanism (same as plans.html)
    let rendered = false;
    let lastToolOutputValue = null;
    let checkCount = 0;
    const maxChecks = 800; // 20 seconds at 25ms/check
    const minTimeBeforeError = 20000; // 20 seconds
    const startTime = Date.now();

    // Property watcher setup
    let toolOutputProxy = null;

    function setupToolOutputWatcher() {
      if (!window.openai || toolOutputProxy) return;

      try {
        const originalDescriptor = Object.getOwnPropertyDescriptor(window.openai, 'toolOutput');

        if (originalDescriptor && originalDescriptor.configurable === false) {
          console.warn('toolOutput property is not configurable, using polling only');
          toolOutputProxy = true;
          return;
        }

        let currentValue = window.openai.toolOutput;

        Object.defineProperty(window.openai, 'toolOutput', {
          get: function () {
            return currentValue;
          },
          set: function (newValue) {
            const oldValue = currentValue;
            currentValue = newValue;

            if ((oldValue === null || oldValue === undefined) &&
              newValue !== null && newValue !== undefined &&
              typeof newValue === 'object') {
              if (newValue.cart || (newValue.structuredContent && newValue.structuredContent.cart)) {
                console.log('‚úÖ toolOutput changed from null to data!');
                setTimeout(() => {
                  if (!rendered) {
                    const success = renderAllCart();
                    if (success) {
                      rendered = true;
                      console.log('‚úÖ Cart rendered (property setter detected)');
                    }
                  }
                }, 10);
              }
            }

            if (originalDescriptor && originalDescriptor.set) {
              originalDescriptor.set.call(this, newValue);
            }
          },
          configurable: true,
          enumerable: true
        });

        toolOutputProxy = true;
        console.log('‚úÖ Set up toolOutput property watcher for cart');
      } catch (e) {
        console.warn('Could not set up property watcher:', e);
        toolOutputProxy = true;
      }
    }

    // Fast polling
    const fastObserver = setInterval(() => {
      if (rendered) {
        clearInterval(fastObserver);
        return;
      }

      checkCount++;

      if (window.openai && !toolOutputProxy) {
        setupToolOutputWatcher();
      }

      if (hasValidToolOutput()) {
        const success = renderAllCart();
        if (success) {
          console.log('‚úÖ Cart rendered successfully (fast observer detected)');
          rendered = true;
          clearInterval(fastObserver);
          return;
        }
      }

      const currentValue = window.openai?.toolOutput;
      if (currentValue !== lastToolOutputValue) {
        lastToolOutputValue = currentValue;
        if (hasValidToolOutput()) {
          const success = renderAllCart();
          if (success) {
            console.log('‚úÖ Cart rendered (value change detected)');
            rendered = true;
            clearInterval(fastObserver);
            return;
          }
        }
      }

      if (checkCount >= maxChecks && Date.now() - startTime >= minTimeBeforeError) {
        console.log('Fast observer timeout after 20 seconds');
        clearInterval(fastObserver);
        if (!rendered) {
          const container = document.getElementById('cart-container');
          if (container) {
            container.innerHTML = '<p style="padding: 20px; text-align: center; color: #d32f2f;">‚ö†Ô∏è Unable to load cart. Please try again.</p>';
          }
        }
      }
    }, 25);

    // Immediate render attempts
    setTimeout(() => {
      if (!rendered && hasValidToolOutput()) {
        const success = renderAllCart();
        if (success) rendered = true;
      }
    }, 100);

    setTimeout(() => {
      if (!rendered && hasValidToolOutput()) {
        const success = renderAllCart();
        if (success) rendered = true;
      }
    }, 500);

    setTimeout(() => {
      if (!rendered && hasValidToolOutput()) {
        const success = renderAllCart();
        if (success) rendered = true;
      }
    }, 1000);

    // Event listeners
    window.addEventListener("load", () => {
      console.log('Load event fired, attempting to render cart');
      if (!rendered) {
        const success = renderAllCart();
        if (success) rendered = true;
      }
    });

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        console.log('DOMContentLoaded fired, attempting to render cart');
        if (!rendered) {
          const success = renderAllCart();
          if (success) rendered = true;
        }
      });
    } else {
      setTimeout(() => {
        console.log('DOM already loaded, attempting to render cart');
        if (!rendered) {
          const success = renderAllCart();
          if (success) rendered = true;
        }
      }, 500);
    }

    // Periodic check as last resort
    const intervalId = setInterval(() => {
      if (rendered) {
        clearInterval(intervalId);
        return;
      }

      if (hasValidToolOutput()) {
        const success = renderAllCart();
        if (success) {
          console.log('‚úÖ Cart rendered successfully (interval check)');
          rendered = true;
          clearInterval(intervalId);
        }
      }
    }, 150);

    setTimeout(() => {
      clearInterval(intervalId);
    }, 20000);
  </script>
</body>

</html>