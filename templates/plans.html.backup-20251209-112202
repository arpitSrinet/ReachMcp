<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mobile Plans</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      padding: 16px;
      background: #f5f5f5;
    }
    
    .plans-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .plan-card {
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 24px;
      background: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }
    
    .plan-card:hover {
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
      transform: translateY(-2px);
    }
    
    .plan-header {
      margin-bottom: 16px;
      border-bottom: 1px solid #e0e0e0;
      padding-bottom: 12px;
    }
    
    .plan-name {
      font-size: 24px;
      font-weight: bold;
      color: #1976d2;
      margin-bottom: 8px;
    }
    
    .plan-data {
      font-size: 18px;
      color: #666;
    }
    
    .plan-pricing {
      margin-bottom: 16px;
    }
    
    .current-price {
      font-size: 32px;
      font-weight: bold;
      color: #1976d2;
      display: block;
    }
    
    .original-price {
      font-size: 20px;
      color: #999;
      text-decoration: line-through;
      margin-right: 8px;
    }
    
    .taxes-note {
      font-size: 14px;
      color: #666;
      margin-top: 4px;
    }
    
    .discount-badge {
      display: inline-block;
      background: #4caf50;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      margin-top: 8px;
    }
    
    .plan-features {
      margin-bottom: 16px;
    }
    
    .feature {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .feature-icon {
      margin-right: 8px;
      font-size: 18px;
    }
    
    .select-button {
      width: 100%;
      background: #1976d2;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    
    .select-button:hover {
      background: #1565c0;
    }
    
    .broadband-facts {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #e0e0e0;
    }
    
    .broadband-facts summary {
      cursor: pointer;
      font-weight: bold;
      color: #666;
      margin-bottom: 8px;
    }
    
    .facts-content {
      font-size: 12px;
      color: #666;
      background: #f5f5f5;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <div class="plans-container" id="plans-container">
    <p style="padding: 20px; text-align: center; color: #666;">Loading plans...</p>
  </div>

  <script>
    // Function to render a single plan card
    function renderPlan(plan) {
      const planId = plan.id || plan.uniqueIdentifier;
      const name = plan.name || plan.displayName;
      const price = plan.price || plan.baseLinePrice || 0;
      const data = plan.data || plan.planData || 0;
      const dataUnit = plan.dataUnit || 'GB';
      const discountPctg = plan.discountPctg || 0;
      
      let originalPrice = null;
      let discountAmount = 0;
      if (discountPctg > 0) {
        originalPrice = Math.round(price / (1 - discountPctg / 100));
        discountAmount = Math.round(originalPrice - price);
      }
      
      const features = [];
      if (plan.isUnlimited || plan.unlimited) {
        features.push({ icon: 'üìû', text: 'Unlimited calls' });
      }
      if (data > 0) {
        features.push({ icon: 'üìä', text: `${data}${dataUnit} high-speed data` });
      }
      if (plan.overageAllowedData && plan.overageAllowedData > 0) {
        features.push({ icon: 'üìà', text: `${plan.overageAllowedData}${plan.overageAllowedDataUnit || 'MB'} additional data` });
      }
      if (plan.maxLines && plan.maxLines > 1) {
        features.push({ icon: 'üë•', text: `Up to ${plan.maxLines} lines` });
      }
      if (plan.additionalLinePrice) {
        features.push({ icon: '‚ûï', text: `Additional lines: $${plan.additionalLinePrice}/mo` });
      }
      if (plan.allowPlanChange) {
        features.push({ icon: 'üîÑ', text: 'Plan changes allowed' });
      }
      
      return `
        <div class="plan-card">
          <div class="plan-header">
            <div class="plan-name">${name}</div>
            <div class="plan-data">${data}${dataUnit}</div>
          </div>
          
          <div class="plan-pricing">
            ${originalPrice ? `<span class="original-price">$${originalPrice}</span>` : ''}
            <span class="current-price">$${price}/mo</span>
            <div class="taxes-note">(Taxes & fees included)</div>
            ${discountAmount > 0 ? `<div class="discount-badge">$${discountAmount} off applied</div>` : ''}
          </div>
          
          <div class="plan-features">
            ${features.map(f => `
              <div class="feature">
                <span class="feature-icon">${f.icon}</span>
                <span>${f.text}</span>
              </div>
            `).join('')}
          </div>
          
          <button class="select-button" onclick="selectPlan('${planId}')">
            üîò Select Plan
          </button>
          
          <details class="broadband-facts">
            <summary>üìã Broadband Facts</summary>
            <div class="facts-content">
              <p>Plan ID: <code>${planId}</code></p>
              ${plan.planType ? `<p>Type: ${plan.planType}</p>` : ''}
              ${plan.serviceCode ? `<p>Service: ${plan.serviceCode}</p>` : ''}
              ${plan.planCharging ? `<p>Charging: ${plan.planCharging}</p>` : ''}
            </div>
          </details>
        </div>
      `;
    }
    
    function selectPlan(planId) {
      // Call MCP tool via OpenAI SDK
      if (window.openai?.callTool) {
        window.openai.callTool('add_to_cart', {
          itemType: 'plan',
          itemId: planId
        }).then(result => {
          alert(`‚úÖ Plan added to cart!`);
          console.log('Cart updated:', result);
        }).catch(error => {
          alert(`Error: ${error.message}`);
          console.error('Error adding to cart:', error);
        });
      } else {
        console.error('window.openai.callTool not available');
        alert('Unable to add to cart. Please try again.');
      }
    }
    
    // Function to render all plans
    function renderAllPlans() {
      const container = document.getElementById('plans-container');
      if (!container) {
        console.error('Plans container not found');
        return false;
      }
      
      // Get tool output data - try multiple possible locations
      const toolOutput = window.openai?.toolOutput || window.openai?.toolResponseMetadata || {};
      const plans = toolOutput.plans || [];
      
      // Debug: Log everything about window.openai
      console.log('=== DEBUG: window.openai state ===');
      console.log('window.openai exists:', !!window.openai);
      if (window.openai) {
        console.log('window.openai keys:', Object.keys(window.openai));
        console.log('window.openai.toolOutput:', window.openai.toolOutput);
        console.log('window.openai.toolResponseMetadata:', window.openai.toolResponseMetadata);
        console.log('window.openai.full object:', JSON.stringify(window.openai, null, 2));
      }
      console.log('toolOutput:', toolOutput);
      console.log('plans array:', plans);
      console.log('plans count:', plans.length);
      console.log('===================================');
      
      // Render all plans
      if (plans.length === 0) {
        // Don't show error yet - just return false so retry continues
        return false;
      } else {
        container.innerHTML = plans.map(renderPlan).join('');
        return true;
      }
    }
    
    // Aggressive retry mechanism with MutationObserver
    let rendered = false;
    let retryCount = 0;
    const maxRetries = 30; // Increased retries even more
    const retryDelays = [50, 50, 50, 100, 100, 100, 200, 200, 200, 300, 300, 300, 500, 500, 500, 500, 500, 500, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000];
    
    function tryRenderWithRetry() {
      if (rendered) return; // Already rendered, stop retrying
      
      const container = document.getElementById('plans-container');
      if (!container) {
        console.error('Plans container not found');
        return;
      }
      
      // Check if window.openai is available and has toolOutput
      if (window.openai?.toolOutput) {
        const success = renderAllPlans();
        if (success) {
          console.log('‚úÖ Plans rendered successfully');
          rendered = true;
          return;
        }
      }
      
      // If not ready and haven't exceeded max retries, try again
      if (retryCount < maxRetries) {
        const delay = retryDelays[retryCount] || 1000;
        // Only log every 5th retry to reduce console spam
        if (retryCount % 5 === 0) {
          console.log(`Retry ${retryCount + 1}/${maxRetries}...`, {
            hasOpenAI: !!window.openai,
            hasToolOutput: !!window.openai?.toolOutput
          });
        }
        
        setTimeout(() => {
          retryCount++;
          tryRenderWithRetry();
        }, delay);
      } else if (!rendered) {
        // Max retries reached, show error message with debug info
        const debugInfo = window.openai ? 
          `<p style="padding: 10px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; margin: 10px 0;">
            <strong>Debug Info:</strong><br>
            window.openai exists: ‚úÖ<br>
            toolOutput exists: ${window.openai.toolOutput ? '‚úÖ' : '‚ùå'}<br>
            toolResponseMetadata exists: ${window.openai.toolResponseMetadata ? '‚úÖ' : '‚ùå'}<br>
            Available keys: ${Object.keys(window.openai).join(', ')}<br>
            toolOutput value: ${JSON.stringify(window.openai.toolOutput || 'null', null, 2)}
          </p>` : 
          '<p style="padding: 10px; background: #f8d7da; border: 1px solid #dc3545; border-radius: 4px; margin: 10px 0;"><strong>Error:</strong> window.openai is not available</p>';
        
        container.innerHTML = debugInfo + '<p style="padding: 20px; text-align: center; color: #d32f2f;">‚ö†Ô∏è Unable to load plans. Please try again.</p>';
        console.error('Failed to render plans after', maxRetries, 'retries');
      }
    }
    
    // Use fast observer to watch for window.openai.toolOutput being populated
    function watchForOpenAI() {
      // Check if already available
      if (window.openai?.toolOutput) {
        const success = renderAllPlans();
        if (success) {
          rendered = true;
          console.log('‚úÖ Plans rendered (openai already available)');
          return;
        }
      }
      
      // Watch for window.openai.toolOutput being populated
      let checkCount = 0;
      const maxChecks = 100; // Check for up to 10 seconds (100 * 100ms)
      
      const observer = setInterval(() => {
        checkCount++;
        
        // Check if toolOutput is now available
        if (window.openai?.toolOutput) {
          const success = renderAllPlans();
          if (success) {
            console.log('‚úÖ Plans rendered (detected via observer)');
            rendered = true;
            clearInterval(observer);
            return;
          }
        }
        
        if (checkCount >= maxChecks) {
          console.log('Observer timeout, falling back to retry mechanism');
          clearInterval(observer);
          if (!rendered) {
            tryRenderWithRetry();
          }
        }
      }, 100); // Check every 100ms
    }
    
    // Try immediately
    watchForOpenAI();
    
    // Also start retry mechanism as backup
    setTimeout(() => {
      if (!rendered) {
        tryRenderWithRetry();
      }
    }, 500);
    
    // Also listen for load event as fallback
    window.addEventListener("load", () => {
      console.log('Load event fired, attempting to render plans');
      if (!rendered) {
        renderAllPlans();
      }
    });
    
    // Also try on DOMContentLoaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        console.log('DOMContentLoaded fired, attempting to render plans');
        if (!rendered) {
          renderAllPlans();
        }
      });
    } else {
      // DOM already loaded, try again with delay
      setTimeout(() => {
        console.log('DOM already loaded, attempting to render plans');
        if (!rendered) {
          renderAllPlans();
        }
      }, 500);
    }
    
    // Also try periodically as a last resort (more frequent)
    const intervalId = setInterval(() => {
      if (rendered) {
        clearInterval(intervalId);
        return;
      }
      
      if (window.openai?.toolOutput) {
        const success = renderAllPlans();
        if (success) {
          console.log('‚úÖ Plans rendered successfully (interval check)');
          rendered = true;
          clearInterval(intervalId);
        }
      }
    }, 150); // Check every 150ms
    
    // Clear interval after 20 seconds (increased to give more time)
    setTimeout(() => {
      clearInterval(intervalId);
    }, 20000);
  </script>
</body>
</html>

